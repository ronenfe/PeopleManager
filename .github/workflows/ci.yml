name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install NuGet CLI
      shell: powershell
      run: |
        choco install nuget.commandline -y

    - name: Restore NuGet packages
      run: nuget restore PeopleManager.sln

    - name: Build solution
      shell: pwsh
      run: |
        # Locate vswhere (from PATH or common install path) and use it to find MSBuild.exe
        $vswhereCmd = Get-Command vswhere.exe -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source -ErrorAction SilentlyContinue
        if ($vswhereCmd) { $vswhere = $vswhereCmd } else { $vswhere = 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe' }

        if (-not (Test-Path $vswhere)) {
          Write-Error "vswhere.exe not found at $vswhere"
          exit 1
        }

        $msbuildPath = & $vswhere -latest -products * -requires Microsoft.Component.MSBuild -find MSBuild\**\Bin\MSBuild.exe | Select-Object -First 1
        if (-not $msbuildPath) {
          Write-Error "MSBuild.exe not found on the runner"
          exit 1
        }

        Write-Host "Using MSBuild: $msbuildPath"
        & $msbuildPath 'PeopleManager.sln' '/p:Configuration=Debug' '/m'

    - name: Run unit tests
      run: |
        echo Running tests...
        vstest.console.exe "PeopleManager.Tests\bin\Debug\PeopleManager.Tests.dll"

    - name: Upload test results (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          PeopleManager.Tests\TestResults || true
